<!DOCTYPE html>
<html>
<head>
  <title>Test Google OAuth</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1 { color: #4285F4; }
    button {
      background: #4285F4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      max-height: 400px;
    }
    .success { color: #0f9d58; }
    .error { color: #db4437; }
  </style>
</head>
<body>
  <h1>Test Google OAuth Integration</h1>
  
  <p>This page allows you to test the OAuth integration with Google to verify it's working correctly.</p>
  
  <div>
    <button id="authorize">Start Google OAuth Flow</button>
  </div>
  
  <h2>Results:</h2>
  <div id="result">
    <p>No OAuth flow has been initiated yet.</p>
  </div>
  
  <script>
    // Configuration
    const clientId = window.prompt('Enter your Google OAuth Client ID', '');
    const redirectUri = 'https://altiverr-webhook-relay.vercel.app/api/oauth2/rest/oauth2-credential/callback';
    
    // Generate a random state value (simulating what n8n does)
    const generateState = () => {
      const stateObj = {
        token: Math.random().toString(36).substr(2, 20),
        cid: 'TEST_CREDENTIAL_ID',
        createdAt: Date.now()
      };
      return btoa(JSON.stringify(stateObj));
    };
    
    // Set up OAuth URL
    const authorizeButton = document.getElementById('authorize');
    authorizeButton.addEventListener('click', () => {
      const state = generateState();
      
      // Store state in localStorage for verification later
      localStorage.setItem('oauth_test_state', state);
      
      // Construct the OAuth URL
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
        `client_id=${encodeURIComponent(clientId)}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&response_type=code` +
        `&scope=${encodeURIComponent('https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly')}` +
        `&access_type=offline` +
        `&state=${encodeURIComponent(state)}` +
        `&prompt=consent`;
      
      // Open the OAuth window
      const authWindow = window.open(authUrl, 'oauth', 'width=600,height=700');
      
      // Set up message listener to receive results
      window.addEventListener('message', (event) => {
        if (event.data && (event.data.type === 'oauth-credential-auth-complete' || 
                           event.data.type === 'oauth-credential-auth-error')) {
          const resultDiv = document.getElementById('result');
          
          if (event.data.type === 'oauth-credential-auth-complete') {
            resultDiv.innerHTML = `
              <p class="success">✅ OAuth flow completed successfully!</p>
              <p>Token data received from the callback:</p>
              <pre>${JSON.stringify(event.data, null, 2)}</pre>
              <p>Check the n8n-oauth-state in localStorage:</p>
              <pre>${localStorage.getItem('n8n-oauth-state') || 'Not found'}</pre>
            `;
          } else {
            resultDiv.innerHTML = `
              <p class="error">❌ OAuth flow failed!</p>
              <p>Error message: ${event.data.error || 'Unknown error'}</p>
            `;
          }
        }
      }, false);
    });
  </script>
</body>
</html> 